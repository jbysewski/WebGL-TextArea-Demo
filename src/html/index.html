<html>

   <head>
      <title>WebGL TextArea Demo</title>
      <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
      
      <script type="text/javascript" src="../js/primitives.js"></script>
      <script type="text/javascript" src="../js/shaderhelper.js"></script>
      <script type="text/javascript" src="../js/texture.js"></script>
      <script type="text/javascript" src="../js/font.js"></script>

      <script type="text/javascript" src="../js/gl-matrix-min.js"></script>
      <script type="text/javascript" src="../js/slider/range.js"></script>
      <script type="text/javascript" src="../js/slider/timer.js"></script>
      <script type="text/javascript" src="../js/slider/slider.js"></script>
      <link type="text/css" rel="StyleSheet" href="../css/bluecurve/bluecurve.css" />

      <script id="plain-shader-fs" type="x-shader/x-fragment">
         precision mediump float;

         void main(void) {
            gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
         }
      </script>

      <script id="plain-shader-vs" type="x-shader/x-vertex">
         attribute vec3 aVertexPosition;

         uniform mat4 uMVMatrix;
         uniform mat4 uPMatrix;

         void main(void) {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
         }
      </script>

      <script id="texture-shader-fs" type="x-shader/x-fragment">
         precision mediump float;

         varying vec2 vTextureCoord;
         uniform sampler2D uSampler;

         void main(void) {
            //gl_FragColor = vec4(vTextureCoord.s, vTextureCoord.t, 1.0, 1.0);
            gl_FragColor = texture2D(uSampler, vTextureCoord);
         }
      </script>

      <script id="texture-shader-vs" type="x-shader/x-vertex">
         attribute vec3 aVertexPosition;
         attribute vec2 aTextureCoord;

         uniform mat4 uMVMatrix;
         uniform mat4 uPMatrix;

         varying vec2 vTextureCoord;

         void main(void) {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
            vTextureCoord = aTextureCoord;
         }
      </script>


<script type="text/javascript">

   var gl;
   function initGL(canvas) {
      try {
         gl = canvas.getContext("experimental-webgl",  { alpha: false });
         gl.viewportWidth = canvas.width;
         gl.viewportHeight = canvas.height;
      } catch (e) {
      }
      if (!gl) {
         alert("Could not initialize WebGL, sorry :-(");
      }
   }

   var plainShader;
   var textureShader;

   function initShaders() {
      plainShader = createProgram(
            "plain-shader-fs", 
            "plain-shader-vs", 
            {vertexPositionAttribute: "aVertexPosition"}, 
            {pMatrixUniform: "uPMatrix", mvMatrixUniform: "uMVMatrix"}
            );

      textureShader = createProgram(
            "texture-shader-fs", 
            "texture-shader-vs", 
            {vertexPositionAttribute: "aVertexPosition", textureCoordAttribute: "aTextureCoord"}, 
            {pMatrixUniform: "uPMatrix", mvMatrixUniform: "uMVMatrix", uTexture: "uSampler"}
            );
   }

   var mvMatrix = mat4.create();
   var pMatrix = mat4.create();

   var triangle;
   var square;
   var texture;
   var font;

   function createScene() {
      triangle = new Triangle();
      square = new Square();
      texture = loadTexture("../media/Monospaced.png");
      font = new Font();
   }

   function drawScene() {
      requestAnimFrame(drawScene);
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
      
      mat4.identity(mvMatrix);
      mat4.translate(mvMatrix, [-7, -5, -15]);
      mat4.rotate(mvMatrix, new Date().getTime() / 1000, [0,0,1]);

      triangle.draw(plainShader, mvMatrix);

      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, texture);
      gl.uniform1i(textureShader.uTexture, 0);
      
      square.draw(textureShader);
      drawText(
            "Hello WebGL!\n" +
            "This is a test for a simple 2D bitmap font drawing technique.\n" +
            "Every character is drawn as a textured quad consisting of two triangles.\n" + 
            "These are then textured with a texture containing a map of 256 characters\n" + 
            "(ASCII). As WebGL which implements OpenGL ES does not allow for GL_QUAD or\n" +
            "DisplayLists other possibilites for optimization have to be investigated.\n\n" +
            "Another problem is the vertical spacing of the individual characters,\n" + 
            "currently non-monospaced fonts will look really akward. Kerning will have\n" +
            "to be taken into account too. I'm filling up with lorem ipsum.\n" +
            "Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo \n" +
            "ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis \n" + 
            "parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, \n" + 
            "pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec \n" + 
            "pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim, \n" + 
            "rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu \n" +
            "mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper.\n" +
            "Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, vitae,\n" + 
            " eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat \n" +
            "a, tellus. Phasellus viverra nulla ut metus varius laoreet. Quisque rutrum. \n" + 
            "Aenean imperdiet. Etiam ultricies nisi vel augue. Curabitur ullamcorper \n" +
            "ultricies nisi. Nam eget dui. Etiam rhoncus. Maecenas tempus, tellus eget \n" +
            "condimentum rhoncus, sem quam semper libero, sit amet adipiscing sem neque \n" +
            "sed ipsum. Nam quam nunc, blandit vel, luctus pulvinar, hendrerit id.\n" +
            "Maecenas nec odio et ante tincidunt tempus. Donec vitae sapien ut libero \n" +
            "venenatis faucibus. Nullam quis ante. Etiam sit amet orci eget eros \n" +
            "tincidunt. Duis leo. Sed fringilla mauris sit amet nibh. Donec sodales \n" +
            "sagittis magna. Sed consequat, leo eget bibendum sodales, augue velit.");
   }

   function drawText(text) {
      var lines = text.split("\n");
      for(var i=0; i<lines.length; i++)
      {
         font.drawLine(textureShader, lines[i], -36.0, 27 - i*1.5 + 40 - s.getValue());
      }
   }


   function webGLStart() {
      var canvas = document.getElementById("canvas");
      initGL(canvas);
      initShaders();      
      createScene();

      gl.clearColor(0.0, 0.0, 0.0, 1.0);
      gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);
      gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
      gl.enable(gl.BLEND);
      
      gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);  
      mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, pMatrix);

      drawScene();
   }

window.requestAnimFrame = (function() {
  return window.requestAnimationFrame ||
         window.webkitRequestAnimationFrame ||
         window.mozRequestAnimationFrame ||
         window.oRequestAnimationFrame ||
         window.msRequestAnimationFrame ||
         function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
           window.setTimeout(callback, 1000/60);
         };
})();

</script>


</head>


<body onload="webGLStart();">
   <div style="float: left">
      <canvas id="canvas" style="border: none;" width="800" height="600"></canvas>
   </div>
   <div class="vertical dynamic-slider-control slider" id="slider" style="float: left; height: 200px"> 
	   <input class="slider-input" id="slider-input"/>
   </div>

   <script type="text/javascript">
      var s = new Slider(document.getElementById("slider"), document.getElementById("slider-input"), "vertical");
      s.setMaximum(40)
      s.setValue(40);
   </script>
</body>

</html>
