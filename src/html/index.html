<html>

   <head>
      <title>WebGL TextArea Demo</title>
      <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
      
      <script type="text/javascript" src="../js/primitives.js"></script>
      <script type="text/javascript" src="../js/shaderhelper.js"></script>
      <script type="text/javascript" src="../js/texture.js"></script>
      <script type="text/javascript" src="../js/font.js"></script>

      <script type="text/javascript" src="../js/gl-matrix-min.js"></script>
      <script type="text/javascript" src="../js/slider/range.js"></script>
      <script type="text/javascript" src="../js/slider/timer.js"></script>
      <script type="text/javascript" src="../js/slider/slider.js"></script>
      <link type="text/css" rel="StyleSheet" href="../css/bluecurve/bluecurve.css" />

      <script id="plain-shader-fs" type="x-shader/x-fragment">
         precision mediump float;

         void main(void) {
            gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
         }
      </script>

      <script id="plain-shader-vs" type="x-shader/x-vertex">
         attribute vec3 aVertexPosition;

         uniform mat4 uMVMatrix;
         uniform mat4 uPMatrix;

         void main(void) {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
         }
      </script>

      <script id="texture-shader-fs" type="x-shader/x-fragment">
         precision mediump float;

         varying vec2 vTextureCoord;
         uniform sampler2D uSampler;

         void main(void) {
            //gl_FragColor = vec4(vTextureCoord.s, vTextureCoord.t, 1.0, 1.0);
            gl_FragColor = texture2D(uSampler, vTextureCoord);
         }
      </script>

      <script id="texture-shader-vs" type="x-shader/x-vertex">
         attribute vec3 aVertexPosition;
         attribute vec2 aTextureCoord;

         uniform mat4 uMVMatrix;
         uniform mat4 uPMatrix;

         varying vec2 vTextureCoord;

         void main(void) {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
            vTextureCoord = aTextureCoord;
         }
      </script>


<script type="text/javascript">

   var gl;
   var aspectRatio;
   function setCanvasAndViewportSize() {
      canvas.width = window.innerWidth - 100;
      canvas.height = window.innerHeight - 20;
      gl.viewportWidth = canvas.width;
      gl.viewportHeight = canvas.height;
      aspectRatio = canvas.width/canvas.height;
   }

   function initGL(canvas) {
      try {
         gl = canvas.getContext("experimental-webgl",  { alpha: false });
         setCanvasAndViewportSize();
      } catch (e) {
      }
      if (!gl) {
         alert("Could not initialize WebGL, sorry :-(");
      }
   }

   var plainShader;
   var textureShader;

   function initShaders() {
      plainShader = createProgram(
            "plain-shader-fs", 
            "plain-shader-vs", 
            {vertexPositionAttribute: "aVertexPosition"}, 
            {pMatrixUniform: "uPMatrix", mvMatrixUniform: "uMVMatrix"}
            );

      textureShader = createProgram(
            "texture-shader-fs", 
            "texture-shader-vs", 
            {vertexPositionAttribute: "aVertexPosition", textureCoordAttribute: "aTextureCoord"}, 
            {pMatrixUniform: "uPMatrix", mvMatrixUniform: "uMVMatrix", uTexture: "uSampler"}
            );
   }

   var mvMatrix = mat4.create();
   var pMatrix = mat4.create();

   var triangle;
   var square;
   var texture;
   var font;

   function createScene() {
      triangle = new Triangle();
      square = new Square();
      texture = loadTexture("../media/Monospaced.png");
      font = new Font();
   }

   function drawScene() {
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
      
      mat4.identity(mvMatrix);
      mat4.translate(mvMatrix, [-5 * aspectRatio, -5, -15]);
      mat4.rotate(mvMatrix, new Date().getTime() / 1000, [0,0,1]);

      triangle.draw(plainShader, mvMatrix);

      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, texture);
      gl.uniform1i(textureShader.uTexture, 0);
      
      drawText(
            "Hello WebGL!\n" +
            "This is a test for a simple 2D bitmap font drawing technique.\n" +
            "Every character is drawn as a textured quad consisting of two triangles.\n" + 
            "These are then textured with a texture containing a map of 256 characters\n" + 
            "(ASCII). As WebGL which implements OpenGL ES does not allow for GL_QUAD or\n" +
            "DisplayLists other possibilites for optimization have to be investigated.\n\n" +
            "Another problem is the vertical spacing of the individual characters,\n" + 
            "currently non-monospaced fonts will look really akward. Kerning will have\n" +
            "to be taken into account too. I'm filling up with lorem ipsum.\n" +
            loremIpsum);
   }

   function drawText(text) {
      var lines = text.split("\n");
      for(var i=0; i<lines.length; i++)
      {
         font.drawLine(textureShader, lines[i], -28 * aspectRatio, 27 - i*1.5 + 70 - s.getValue());
      }
   }

   var canvas;
   function webGLStart() {
      canvas = document.getElementById("canvas");
      initGL(canvas);
      initShaders();      
      createScene();

      gl.clearColor(0.0, 0.0, 0.0, 1.0);
      gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, false);
      gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
      gl.enable(gl.BLEND);
      
      gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);  
      mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, pMatrix);

      window.setTimeout(drawScene, 100);
   }

   var loremIpsum;
   function readLoremIpsum() {
      var iframe = document.getElementById("LoremIpsum");
      var doc;
      if(iframe.contentDocument)
         doc = iframe.contentDocument;
      else if(iframe.contentWindow)
         doc = iframe.contentWindow.document;
      loremIpsum = doc.body.textContent;
   }

   
</script>


</head>


<body onload="webGLStart();" onresize="webGLStart();">
   <div style="float: left">
      <canvas id="canvas" style="border: none;" width="800" height="600"></canvas>
   </div>
   <div class="vertical dynamic-slider-control slider" id="slider" style="float: left; height: 100%"> 
	   <input class="slider-input" id="slider-input"/>
   </div>

   <iframe id="LoremIpsum" src="../media/LoremIpsum.txt" onload="readLoremIpsum()" style="visibility: hidden;"></iframe>

   <script type="text/javascript">
      var s = new Slider(document.getElementById("slider"), document.getElementById("slider-input"), "vertical");
      s.setMaximum(70)
      s.setValue(70);
      s.onchange = function() {
         drawScene();
      }
   </script>
</body>

</html>
